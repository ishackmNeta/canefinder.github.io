<html>

  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="-1">
<head>
  <title>Neta Geo App</title>
  
  <script>
    function myFunction() {
      alert("Welcome to the Neta Geo App.Please wait for a few seconds.");
    }
    
    myFunction()


  </script>
 <!-- import all css and js files -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <script src="js/jquery.min.js"></script>
  <script src="js/leaflet.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/L.Control.Locate.min.css" />
  <script src="js/L.Control.Locate.min.js" charset="utf-8"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
  <script
  src="https://code.jquery.com/jquery-3.5.1.js"
  integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
  crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet-src.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    
<link rel="stylesheet" href="Control.FullScreen.css"/>
<script src="js/Control.FullScreen.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
<script src="js/leaflet.draw.js"></script>

<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<link rel="stylesheet" href="css/jquery-ui.css"/>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link rel="stylesheet" href="css/measure/leaflet.measure.css" />
<script src="css/measure/leaflet.measure.js"></script>

   <link rel="stylesheet" href="leaflet-search.css"/>
   <script src="js/leaflet-search.js"></script>
    <script src="js/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="css/leaflet-legend.css"/>
    <script src="js/leaflet-legend.js"></script>
    <script src="SliderControl.js"></script>

    <link rel="stylesheet" href="L.Control.Layers.Tree.css"/>
    <script src="L.Control.Layers.Tree.js"></script>

   


    <!-- style of map and labels -->
  <style>
    #map{ width: 100%; height: 100%; }

  #export {
  position: absolute;
  top: 550px;
  right: 20px;
  padding: 10px;
  z-index: 400;
}

.leaflet-tooltip.my-labels {
  background-color:wheat;
  border: red;
  box-shadow: none;
  }



  .info {
    background:#fff;
    position:absolute;
    width:260px;
    top:10px;
    right:10px;
    border-radius:2px;
    }
    .info .item {
      display:block;
      border-bottom:1px solid #eee;
      padding:10px;
      text-decoration:none;
      }
      .info .item small { color:#888; }
      .info .item:hover,
      .info .item.active { background:#f8f8f8; }
      .info .item:last-child { border-bottom:none; }

.leaflet-popup-content {
  width:240px;    
  }

.tabs {
    position:relative;
    min-height:200px;
    clear:both;
    margin:25px 0;
}
.tab {
    float:left;
    display: none;
}
.tab:first-of-type {
    display: inline-block;
}
.tabs-link {
    position: relative;
    top: -14px;
    height: 20px;
    left: -40px;
}
.tab-link {
    background:#eee;
    display: inline-block;
    padding:10px;
    border:1px solid #ccc;
    margin-left:-1px;
    position:relative;
    list-style-type: none;
    left:1px;
    top:1px;
    cursor:pointer;
}
.tab-link {
    background:#f8f8f8;
}
.content {
    background:white;
    position:absolute;
    top:28px;
    left:0;
    right:0;
    bottom:0;
    padding:20px;
    border:1px solid #ccc;
}
.tab:target {
    display: block;
}
  
  </style>




</head>
<body>

  
    <!-- body sections -->


  <div id="map"></div>
  <div id='delete'></div>
  <a href='#' id='export' class="btn btn-success">Export Features</a>
</body>


  <script>

    //OSM tiles attribution and URL
		var osmLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
		var osmURL = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		var osmAttrib = '&copy; ' + osmLink;
		
		//Carto tiles attribution and URL
		var cartoLink = '<a href="http://cartodb.com/attributions">CartoDB</a>';
		var cartoURL = 'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}{r}.png';
		var cartoAttrib = '&copy; ' + osmLink + ' &copy; ' + cartoLink;

		//Stamen Toner tiles attribution and URL
		var stamenURL = 'http://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.{ext}';
		var stamenAttrib = 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';

		//Creation of map tiles
		var osmMap = L.tileLayer(osmURL, {attribution: osmAttrib});
		var cartoMap = L.tileLayer(cartoURL, {attribution: cartoAttrib});

  // initialize the map


  var map = L.map(
                "map",
                {
                    center: [17.700988639056899,77.583116505730501],
                    crs: L.CRS.EPSG3857,
                    zoom: 14,
                    fullscreenControl: true,
                    preferCanvas: true,
                    drawControl: false,
                    titles: "Punggol",
                }
            );
            

  // load a tile layer
  var original = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    {
      attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
      zoomControl: true,
      drawControl: true,
      preferCanvas: true
    }).addTo(map);

  </script>
  <script>

// create array for csv export
var arr = [['Plot code','Ryot Number','Ryot Name','Ryot Village','Plot Village','Date','Time','Latitude','Longtitude']];
var borewell_data = [['SI Number','District','Source Of','Crop Data','Date','Time','Latitude','Longtitude']];


function onPopupOpen(e) {
  // check if you it is okay for the popup to open - if not, close it.
  if (!enablePopups.checked) {
    // "this" refers to the marker object of the marker that was clicked on, whereas
    // e.target will refer to the DOM element itself
    this.closePopup();
  }
}


// style for kml
function sugar(feature) {
    return {
        fillColor: 'green',
        color: 'green'  //Outline color
    };
}

// highlight colour
var highlight = {
		'fillColor': 'yellow',
		'weight': 2,
		'opacity': 1
	};

  function kml_nam(feature, layer) {
  layer.bindPopup("Plot Code:" + feature.properties.new_name + '<br>' + 'Ryot Number:' + feature.properties.ryot + '</br>' + 'Ryot Name:' + feature.properties.ryotname + '</br>'
  + 'Ryot Village:' + feature.properties.ryotvillage + '<br> Plot Village:' + feature.properties.plotvillage,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false},
  );







 // initialize array and export csv

var test = layer.on("click", function (e) {
                kml.setStyle(sugar); //resets layer colors
                layer.setStyle(highlight);  //highlights selected.
                var name = feature.properties.Name
                var ryot = feature.properties.ryot
                var ryotname = feature.properties.ryotname
                var ryotvillage = feature.properties.ryotvillage
                var plotvillage = feature.properties.plotvillage
                var cord = e.latlng
                var lat = ([Object.values(cord)[0]]); //returns 'someVal'
                var long = ([Object.values(cord)[1]]); //returns 'someVal'
                var time = new Date().toLocaleString();
                var date = new Date().toLocaleDateString();
                arr.push([name,ryot,ryotname,ryotvillage,plotvillage,time,lat,long]);
                var nkml = arr.length - 1; 
                var person = prompt("Are you done finishing collecting data?" + " Number of plots visited/to visit today:" + nkml);
                if (person == "yes") {
                let csvContent = "data:text/csv;charset=utf-8," 
                + arr.map(e => e.join(",")).join("\n");
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                var filename = date + '.csv'
                link.setAttribute("download", filename);
                document.body.appendChild(link); // Required for FF
                link.click();

  }

                



                
            }); 

 }
// add geojson to map
  var kml = new L.GeoJSON.AJAX("data/unit2_kml_oct.geojson",{
         style:sugar, onEachFeature: kml_nam});   

// add streamnetwork geojson

var riverm = {
    "color": "orange",
    "weight": 3,
    "opacity": 0.65
};
  function network(feature, layer) {
  layer.bindPopup("2 Hectare Stream Network");
 }


  var group3 = new L.GeoJSON.AJAX("data/streamnetwork.geojson",{
         style:riverm, onEachFeature: network});   

         //group3.addTo(map);



// add village boundaries geojson


url = '<br><a href="https://www.natems.com/">Know more here</a></br>'

function polystyle(feature) {
    return {
        fillColor: 'white',
        weight: 2,
        opacity: 1,
        color: 'red',  //Outline color
        fillOpacity: 0.1
    };
}


function village(feature, layer) {
  layer.bindPopup('<dl> <b>Village Information</b> <dd> Village Name:'+ feature.properties.Name 
  +'</dd>Village ID:'+ feature.properties.id 
  +'</dd> <dd> Trident Area:'+ feature.properties.trident + '</dd>'
  +'</dd> <dt>Sugarcane Plots</dt>'+
  '<dd>No.of Sugarcane Plots: 300</dd>' + '<dd>Area of Sugarcane Plots: 5000 acres</dd>'+
  '<dt>Sugarcane Plot Status</dt>'+ 
  '<dd>Green: 300</dd>' 
  +'<dd>Yellow: 200</dd>' 
  +'<dd>Red: 159</dd>' +
  '<dt>Number of Visits</dt>'+ 
  '<dd>0-5: 300</dd>' 
  +'<dd>6-15: 200</dd>' 
  +'<dd>16-30: 159</dd>' 
  + '<dt>Number of Plots Per Season</dt>'+ 
  '<dd>2017/18: 300</dd>' 
  +'<dd>2018/19: 200</dd>' 
  +'<dd>2019/20: 159</dd>' 
  
 );
 }

var group4 = new L.GeoJSON.AJAX("data/village.geojson",{
         style:polystyle,onEachFeature: village});   

         group4.addTo(map);



    function rstyle(feature) {
    return {
        fillColor: 'white',
        weight: 2,
        opacity: 1,
        color: 'blue',  //Outline color
        fillOpacity: 0.1
    };
}
        


var radius = new L.GeoJSON.AJAX("http://netaapi.pythonanywhere.com/static/radius.geojson",{
         style:rstyle});   

         //radius.addTo(map);

// Locate me function using GPS


  var yellow = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

  function onLocationFound(e) {
  var radius = e.accuracy / 2;
  var marker = L.marker(e.latlng,{icon:yellow}).addTo(map).bindPopup("You are within " + radius + " meters from this point <br>"+ e.latlng).openPopup();
  var circ = L.circle(e.latlng, radius).addTo(map);

 
}
map.on('locationfound', onLocationFound);


// add Narinjavagu River geojson

var river_s = {
    "color": "yellow",
    "weight": 3,
    "opacity": 0.65
};

var rv1 = "Narinjavagu River"


function nari(feature, layer) {
  layer.bindPopup(rv1);
 }

var group2 = new L.GeoJSON.AJAX("data/nari.geojson",{
         style:river_s, onEachFeature: nari});   

         //group2.addTo(map);


// add water structure geojson

var myIcon = L.icon({
  iconUrl: 'icons/dam.png',
  iconSize: [32, 37],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});


var village = "Village: Kothoor B"

function onEachFeature4(feature, layer) {
  layer.bindPopup(village + '<br>' + 'S_No:' + feature.properties.s_no + '<br>' + 'Activity: ' 
  + feature.properties.activity + '</br>' + 'Volume: ' + feature.properties.volume 
  + '</br>' + 'Length: ' + feature.properties.length + 'm</br>'+ 'Width: '
   + feature.properties.width + 'm</br>' + 'Depth: ' + feature.properties.depth + 'm</br>');
}


dam = new L.GeoJSON.AJAX("data/dam.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: myIcon});
    },
  onEachFeature: onEachFeature4
})//.addTo(map);


// add Trident River geojson


var river_t = {
    "color": "purple",
    "weight": 3,
    "opacity": 0.65
};


var rv2 = "Trident Major Stream"


function rv2_f(feature, layer) {
  layer.bindPopup(rv2);
 }


  var group1 = new L.GeoJSON.AJAX("data/trident.geojson",{
         style:river_t, onEachFeature: rv2_f});   

         //group1.addTo(map);



// sunken pit buffer


var b_style = {
    "color": "#808000",
    "weight": 5,
    "opacity": 0.65
};


var spb = new L.GeoJSON.AJAX("data/buffer_SP_50_v2.geojson",{
style:b_style});   

//spb.addTo(map);



var o_style = {
    "color": "red",
    "weight": 5,
    "opacity": 0.65
};


function indis(feature, layer) {
  layer.bindPopup("Plot Code:" + feature.properties.new_name + '<br>' + 'Ryot Number:' + feature.properties.ryot + '</br>' + 'Ryot Name:' + feature.properties.ryotname + '</br>'
  + 'Ryot Village:' + feature.properties.ryotvillage + '<br> Plot Village:' + feature.properties.plotvillage,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false});
 }

var water1 = new L.GeoJSON.AJAX("data/overlap_water.geojson",{
style:o_style,onEachFeature: indis});   

//water1.addTo(map);

// check dam buffer

var kml1 = new L.GeoJSON.AJAX("data/kml1.geojson",{
style:o_style,onEachFeature: indis});   

var kml6 = new L.GeoJSON.AJAX("data/kml6.geojson",{
style:o_style,onEachFeature: indis});   

var kml10 = new L.GeoJSON.AJAX("data/kml10.geojson",{
style:o_style,onEachFeature: indis});   


var b1 = new L.GeoJSON.AJAX("data/buffer1.geojson",{
style:b_style});   

var b6 = new L.GeoJSON.AJAX("data/buffer6.geojson",{
style:b_style});   

var b10 = new L.GeoJSON.AJAX("data/buffer10.geojson",{
style:b_style});   


var bufferm1 = L.layerGroup([b1,kml1]);
var bufferm6 = L.layerGroup([b6,kml6]);
var bufferm10 = L.layerGroup([b10,kml10]);

// crops data




function crop_popup(feature, layer) {
  layer.bindPopup('<dl> <b>Demostration Details</b> <dd> Crops/Fertilizer:'
  + feature.properties.cn +'</dd>Variety:'+ feature.properties.variety
  +'</dd> <dd> Soil Type:'+ feature.properties.soil + '</dd>'
  +'</dd> <dt>Ryot Details</dt>'+
  '<dd>Ryot Code:'+ feature.properties.ryot + '</dd>' +
  '<dd>Farmer Name:'+ feature.properties.Name + '</dd>' +
  '<dt>Other Information</dt>'+ 
  '<dd>Date of Sowing:'+ feature.properties.date + '</dd>' +
  '<dd>Demo area (in acre): '+ feature.properties.area + '</dd>');
 }


var crops = L.icon({
  iconUrl: 'icons/wheat.png',
  iconSize: [32, 37],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});


crops_demo = new L.GeoJSON.AJAX("data/crops.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon:crops});
    },
  onEachFeature:crop_popup
})//.addTo(map);



{}


// input data

var input = L.icon({
  iconUrl: 'icons/input.png',
  iconSize: [32, 37],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});


input_demo = new L.GeoJSON.AJAX("data/input.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon:input});
    },
  onEachFeature:crop_popup
})//.addTo(map);





// nutrient data

var nutrient = L.icon({
  iconUrl: 'icons/wheelbarrow.png',
  iconSize: [32, 37],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});


nutrient_demo = new L.GeoJSON.AJAX("data/nutrients.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng,{icon:nutrient});
    },
  onEachFeature: crop_popup
})//.addTo(map);







// add Trident Basin geojson

function tb(feature) {
    return {
        fillColor: 'white',
        weight: 5,
        opacity: 1,
        color: 'pink',  //Outline color
        fillOpacity: 0.1
    };
}


var tb1 = "Trident Basin"



var river_t = {
    "color": "purple",
    "weight": 3,
    "opacity": 0.65
};




function basin(feature, layer) {
  layer.bindPopup(tb1);
 }


  var base1 = new L.GeoJSON.AJAX("data/basin.geojson",{
         style:tb, onEachFeature: basin});   

         //base1.addTo(map);


// add Major Road Network geojson


var myStyle = {
    "color": "blue",
    "weight": 5,
    "opacity": 0.65
};



function kar(feature, layer) {
  layer.bindPopup(feature.properties.name);
 }
 
  var roads = new L.GeoJSON.AJAX("data/road.geojson",{
         style:myStyle, onEachFeature: kar});   
  
  
  //roads.addTo(map);


// add waterbodies geojson


  function wb(feature) {
    return {
        fillColor: '#add8e6',
        weight: 2,
        opacity: 1,
        color: 'white',  //Outline color
        fillOpacity: 1
    };
}

  function kar1(feature, layer) {
  layer.bindPopup(feature.properties.name);
 }
  var waterbodies = new L.GeoJSON.AJAX("data/waterbodies.geojson",{
         style:wb, onEachFeature: kar1});   

  //waterbodies//.addTo(map);

// add plot status geojson (Fake Data)
 
  function kml_name2(feature, layer) {
  layer.bindPopup("Plot Code:" + feature.properties.new_name + '<br> Status:' + feature.properties.status + '<br>' + 'Ryot Number:' + feature.properties.Name + '</br>' + 'Ryot Name:' + feature.properties.ryotname + '</br>'
  + 'Ryot Village:' + feature.properties.ryotvillage + '<br> Plot Village:' + feature.properties.plotvillage,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false},
  );

  
  var test = layer.on("click", function (e) {
                kml.setStyle(sugar); //resets layer colors
                
            }); 

 }

 function sugar1(feature) {
    return {
        fillColor: feature.properties.status,
        color: feature.properties.status,  
        fillOpacity: 0.4

    };
}


     function fn(feature) {
                return feature.properties.status === "red";
          }

  var kml2 = new L.GeoJSON.AJAX("data/unit2_kml_oct_status.geojson",{
         style:sugar1, onEachFeature: kml_name2,filter:fn});   

         //kml2.addTo(map);



        


// add Number of Visits geojson (Fake Data)
 

function kml_name3(feature, layer) {
  layer.bindPopup("Plot Code:" + feature.properties.new_name + '<br> Number of Visits:' + feature.properties.visits + '<br>' + 'Ryot Number:' + feature.properties.ryot + '</br>' + 'Ryot Name:' + feature.properties.ryotname + '</br>'
  + 'Ryot Village:' + feature.properties.ryotvillage + '<br> Plot Village:' + feature.properties.plotvillage,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false},
  );



  
var test = layer.on("click", function (e) {
                kml.setStyle(sugar); //resets layer colors
                
            }); 

 }

// colour function based on number of visits
 function getColor(d) {
    return d < 5 ? 'red' :
           d < 10  ? '#BD0026' :
           d < 14  ? '#ac4b1c' :
           d < 18  ? '#FC4E2A' :
           d < 20  ? '#FD8D3C' :
           d < 25  ? '#FEB24C' :
           d < 30  ? '#FED976' :
                      '#FFEDA0';
}


// colour function based on number of visits
function getColor2(d) {
    return d < 5 ? '#f9d276' :
           d < 15  ? '#BD0026' :
           d < 25  ? '#ad1d45' :
           d < 30  ? '#83142c' :
           d < 35  ? '#44000d' :
                     '#FFEDA0';
}

function visits(feature) {
    return {
        fillColor: getColor2(feature.properties.visits),
        weight: 2,
        opacity: 1,
        color:getColor2(feature.properties.visits),
        fillOpacity: 0.7
    };
}

  var kml3 = new L.GeoJSON.AJAX("data/test2.geojson",{
         style:visits, onEachFeature: kml_name3});   

         //kml3.addTo(map);
         
         
         
// add Sunken Pits geojson 

      var sp_icon = L.icon({
      iconUrl: 'icons/dig.png',
      iconSize: [32, 37],
      iconAnchor: [16, 37],
      popupAnchor: [0, -28]
});


         function onEachFeature1(feature, layer) {
  layer.bindPopup('Sunken Pits <br>' + 'S_No:' + feature.properties.si 
  + '<br>' + 'Volume:' + feature.properties.volume + ' m3</br>'+ 'Date of Construction:' + feature.properties.date );
}

sp = new L.GeoJSON.AJAX("data/sunken_pits.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: sp_icon});
    },
  onEachFeature: onEachFeature1
})//.addTo(map);

// // add Borewell geojson 



 function bore1(feature, layer) {
  layer.bindPopup('Sl_No:'+ feature.properties.Sl_No +'<br> District:' + feature.properties.district
   + '<br> Source of: '+ feature.properties.Source_of + '<br> Crops_Data: '
   + feature.properties.crops_deta,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false},
  );





 // initialize array and export csv

var test2 = layer.on("click", function (e) {
                var name = feature.properties.Sl_No
                var district = feature.properties.district
                var source = feature.properties.Source_of
                var crops = feature.properties.crops_deta
                var newchar = '|'
                crops = crops.split(',').join(newchar);
                var cord = e.latlng
                var lat = ([Object.values(cord)[0]]); //returns 'someVal'
                var long = ([Object.values(cord)[1]]); //returns 'someVal'
                var time = new Date().toLocaleString();
                var date = new Date().toLocaleDateString();
                borewell_data.push([name,district,source,crops,time,lat,long]);
                var nkml = borewell_data.length - 1; 
                var person = prompt("Are you done finishing collecting data?" + " Number of borewells selected:" + nkml);
                if (person == "yes") {
                let csvContent = "data:text/csv;charset=utf-8," 
                + borewell_data.map(e => e.join(",")).join("\n");
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                var filename = date + '.csv'
                link.setAttribute("download", filename);
                document.body.appendChild(link); // Required for FF
                link.click();

  }

                



                
            }); 

 }


 
 var bi = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});






bore = new L.GeoJSON.AJAX("data/borewell.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: bi});
    },
  onEachFeature: bore1
})//.addTo(map);



                



// // add soil geojson 

function soil(feature, layer) {
  layer.bindPopup('Ryot Number:'+ feature.properties.ryot 
  +'<br> Village:' + feature.properties.village 
  + '<br> Farmer Name: '+ feature.properties.farmer 
  + '<br> Type of Soil: '+ feature.properties.soil
  + '<br> Date of Soil Sample Taken: '+ feature.properties.date
  + '<br> Type of Crops: '+ feature.properties.crops );
;
 }

 var soil_icon = new L.Icon({
  iconUrl: 'icons/test-tube.png',
  //shadowUrl: 'icons/test-tube.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  //shadowSize: [41, 41]
});

soil_sample = new L.GeoJSON.AJAX("data/soil_samples.geojson", {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: soil_icon});
    },
  onEachFeature: soil
})//.addTo(map);



// add Number of Rural Entreprenuers geojson (Fake Data)


var re = new L.GeoJSON.AJAX("data/re.geojson", {
  pointToLayer: function(feature,latlng){
    label = feature.properties.title + "<br> Number of Rural Entreprenuers:" + String(feature.properties.field)  // Must convert to string, .bindTooltip can't use straight 'feature.properties.attribute'
    id = Number(feature.properties.field) // Must convert to string, .bindTooltip can't use straight 'feature.properties.attribute'
    var geojsonMarkerOptions = {radius:id,fillColor:getColor(id),color: "#000",weight: 1,opacity: 1,fillOpacity: 0.8};
    return new L.CircleMarker(latlng,geojsonMarkerOptions).bindTooltip(label, {permanent: false, 
   direction: "center",
   className: "my-labels"}).openTooltip();
    }
  });
//map.addLayer(re);
     




// style for op
function op(feature) {
    return {
        fillColor: 'red',
        color: 'red'  //Outline color
    };
}




function kml_name4(feature, layer) {
  layer.bindPopup("Plot Code:" + feature.properties.new_name + '<br> Status:' + feature.properties.status + '<br>' + 'Ryot Number:' + feature.properties.Name + '</br>' + 'Ryot Name:' + feature.properties.ryotname + '</br>'
  + 'Ryot Village:' + feature.properties.ryotvillage + '<br> Plot Village:' + feature.properties.plotvillage,
  {closeButton: true, closePopupOnClick:false,closeOnClick:false,autoClose:false},
  );

  var test = layer.on("click", function (e) {
                kml.setStyle(op); //resets layer colors
                
            }); 

 }

  var op2 = new L.GeoJSON.AJAX("http://netaapi.pythonanywhere.com/static/plots.geojson",{
         style:op, onEachFeature: kml_name4});   

         //op2.addTo(map);


         var bufferm = L.layerGroup([spb,water1]);


// Layer Control

var overlayMaps = {
    "<img src='icons/purple.png' /> Trident Main River": group1,
    "<img src='icons/yellow.png' /> Narinjavagu River": group2,
    "<img src='icons/orange.png' /> Stream Network 2 Hectare": group3,
    "<img src='icons/red.png' /> Village": group4,
    "<img src='icons/dig.png' /> Sunken Pits": sp,
    "<img src='https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png' /> Borewells": bore,
    "<img src='icons/pink.png' /> Trident Basin": base1,
    "<img src='icons/road.png' /> Major Road Network": roads,
    "<img src='' /> Waterbodies": waterbodies,
    "<img src='' /> Sugarcane Plot Status": kml2,
    "<img src='' /> Number of Visits": kml3,
    "<img src='' /> Sugarcane Plots": kml,
    "<img src='' /> Bufferzone": bufferm,
    "<img src='icons/wheelbarrow.png' /> Nutrient Data": nutrient_demo,
    "<img src='icons/input.png' /> Input Data": input_demo,
    "<img src='icons/wheat.png' /> Crop Data": crops_demo,
    "<img src='icons/test-tube.png' /> Soil Samples": soil_sample,
    "<img src='icons/follow.png' /> Number of re": re,
    "<img src='icons/dam.png' /> Check Dams/Percolation Tanks": dam

    
 
};




var baseLayers = {
			"OSM Mapnik": osmMap,
			"Stamen Toner": original
		};
	  
		 //Add baseLayers to map as control layers

//L.control.layers(baseLayers, overlayMaps).addTo(map);




var overlaysTree = {
    label: '<b>Layer Options</b>',
    children: [
        {
            label: 'Please select your basemap layer',
            selectAllCheckbox: false,
            children: [
                {
                    label: '<b>BaseMap Layer</b>',
                    selectAllCheckbox: false,
                    children: [
                        { label: "Stamen Toner", layer: original },
                        { label: 'OSM Mapnik', layer: osmMap },
                    ]
                }, 
                

                
                
            ]


            
            
        }, 
         {
            label: '<b>Data Layers</b>',
            selectAllCheckbox: false,
            children: [
                {
                    label: '<b>Rivers</b>',
                    selectAllCheckbox: false,
                    children: [
                        { label: "<img src='icons/purple.png' /> Trident Main River", layer: group1 },
                        { label:  "<img src='icons/orange.png' /> Stream Network 2 Hectare", layer: group3 },
                        { label: "<img src='icons/yellow.png' /> Narinjavagu River", layer: group2}
                    ]
                }, 

                
                {
                    label: '<b>Sugarcane Plots </b>',
                    selectAllCheckbox: false,
                    children: [
                        { label: "<img src='' /> Sugarcane Plots", layer: kml },
                        { label:  "<img src='' /> Sugarcane Plot Status", layer: kml2 },
                        { label: "<img src='' /> Number of Visits", layer: kml3}
                    ]
                },
                


                {
                    label: '<b> Ground Data </b>',
                    selectAllCheckbox: false,
                    children: [
                        { label: "<img src='icons/wheelbarrow.png' /> Nutrient Data",layer: nutrient_demo },
                        { label: "<img src='icons/input.png' /> Input Data", layer: input_demo },
                        { label: "<img src='icons/test-tube.png' /> Soil Samples", layer: soil_sample },
                        { label:   "<img src='icons/wheat.png' /> Crop Data", layer: crops_demo}
                    ]
                },


                {
                    label: '<b> Sunken Pits, Borewells and Water Structures </b>',
                    selectAllCheckbox: false,
                    children: [
                        { label:   "<img src='icons/dig.png' /> Sunken Pits",layer: sp },
                        { label:     "<img src='icons/dam.png' /> Check Dams/Percolation Tanks", layer: dam },
                        { label:     "<img src='https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png' /> Borewells", layer: bore },
                        { label:    "<img src='' /> Waterbodies", layer: waterbodies}
                    ]
                },

                {
                    label: '<b> Buffer Zones </b>',
                    selectAllCheckbox: true,
                    children: [
                        { label:    "<img src='' /> 50 Km Sunken Pit",layer: bufferm },  
                        { label:    "<img src='' /> 100 Km Check Dam_S1",layer: bufferm1 },  
                        { label:    "<img src='' /> 100 Km Check Dam_S6",layer: bufferm6 },  
                        { label:    "<img src='' /> 100 Km Check Dam_S10",layer: bufferm10 },  

                     
                    ]
                },

                {
                    label: '<b> Other Layers </b>',
                    selectAllCheckbox: false,
                    children: [
                        { label:    "<img src='icons/pink.png' /> Trident Basin",layer: base1 },  
                        { label:    "<img src='icons/road.png' /> Major Road Network",layer: roads }, 
                        { label:        "<img src='icons/red.png' /> Village",layer: group4 },                                           
                        { label:     "<img src='icons/follow.png' /> Number of re",layer: re }                       
                     
                    ]
                }
                
              
               
            ]
        }
    ]
}




L.control.layers.tree(baseLayers, overlaysTree).addTo(map);



// search by  code, ryot code and village name
var test = L.layerGroup([kml,group4,kml2]);

// L.Control.Search
var searchControl = new L.Control.Search({
		layer: test,
		propertyName: 'Name',
		marker: false,
		moveToLocation: function(latlng, title, map) {
			//map.fitBounds( latlng.layer.getBounds() );
			var zoom = map.getBoundsZoom(latlng.layer.getBounds());
  			map.setView(latlng,15); // access the zoom
		}
	});

	searchControl.on('search:locationfound', function(e) {
		
		//console.log('search:locationfound', );

		//map.removeLayer(this._markerSearch)

		//e.layer.setStyle({fillColor: '#3f0', color: '#0f0'});
		if(e.layer._popup)
			e.layer.openPopup();

	}).on('search:collapsed', function(e) {

		featuresLayer.eachLayer(function(layer) {	//restore feature color
			featuresLayer.resetStyle(layer);
		});	
	});
	
	map.addControl( searchControl );  //inizialize search control

  var lc = L.control.locate({
    layer: lc,
    strings: {
        title: "Show me where I am, yo!"
    }
}).addTo(map);



// Leaflet Measure plugin

L.control.measure({
  position: 'topleft'
}).addTo(map)



// Leaflet Draw plugin - Draw and export as Geojson File


// FeatureGroup is to store editable layers
var drawnItems = L.geoJson().addTo(map);
map.addControl(new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    }
}));

map.on('draw:created', function (event) {
    var layer = event.layer,
    	feature = layer.feature = layer.feature || {};
    
    feature.type = feature.type || "Feature";
    var props = feature.properties = feature.properties || {};
    //layer.feature = {properties: {}}; // No need to convert to GeoJSON.
    //var props = layer.feature.properties;
    props.desc = null;
    props.image = null;
    drawnItems.addLayer(layer);
    addPopup(layer);
});

function addPopup(layer) {
	var content = document.createElement("textarea");
    content.addEventListener("keyup", function () {
    	layer.feature.properties.desc = content.value;
    });
    layer.on("popupopen", function () {
    	content.value = layer.feature.properties.desc;
      content.focus();
    });
    layer.bindPopup(content).openPopup();
    var ishack = (layer.getLatLng())
    var lat = ([Object.values(ishack)[0]]); //returns 'someVal'
    var long = ([Object.values(ishack)[1]]); //returns 'someVal'
    var uae1 = lat.toString(2);
    var uae2 = long.toString(2);
    var cord = "Latitude <br> " + uae1 + " <br> Longitude <br> " + uae2
    layer.bindTooltip(cord).openTooltip();




}



        // on click, clear all layers
        
        document.getElementById('export').onclick = function(e) {
            // Extract GeoJson from featureGroup
            var data = drawnItems.toGeoJSON();

            // Stringify the GeoJson
            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));

            // Create export
            document.getElementById('export').setAttribute('href', 'data:' + convertedData);
            document.getElementById('export').setAttribute('download','data.geojson');
        }

	  
// right click anywhere in the map and get weather data 
	  


var popup = L.popup();

//popup function
function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString()) //esample from leaflet, will be immediately replaced by weatherpopup...
        .openOn(map);


//getting json function
jQuery(document).ready(function(){
  $.ajax({
    url: "https://api.openweathermap.org/data/2.5/weather?lat=" + e.latlng.lat + '&lon=' + e.latlng.lng + "&appid=74adc293e79c9b63b53db93537130882",
    dataType: 'json',
    success: function(data) {
      // storing json data in variables
      weatherlocation_lon = data.coord.lon; // lon WGS84
      weatherlocation_lat = data.coord.lat; // lat WGS84
      weatherstationname = data.name // Name of Weatherstation
      weatherstationid = data.id // ID of Weatherstation
      weathertime = data.dt // Time of weatherdata (UTC)
      temperature = data.main.temp; // Kelvin
      airpressure = data.main.pressure; // hPa
      airhumidity = data.main.humidity; // %
      temperature_min = data.main.temp_min; // Kelvin
      temperature_max = data.main.temp_max; // Kelvin
      windspeed = data.wind.speed; // Meter per second
      winddirection = data.wind.deg; // Wind from direction x degree from north
      cloudcoverage = data.clouds.all; // Cloudcoverage in %
      weatherconditionid = data.weather[0].id // ID
      weatherconditionstring = data.weather[0].main // Weatheartype
      weatherconditiondescription = data.weather[0].description // Weatherdescription
      weatherconditionicon = data.weather[0].icon // ID of weathericon

    // Converting Unix UTC Time
    var utctimecalc = new Date(weathertime * 1000);
    var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    var year = utctimecalc.getFullYear();
    var month = months[utctimecalc.getMonth()];
    var date = utctimecalc.getDate();
    var hour = utctimecalc.getHours();
    var min = utctimecalc.getMinutes();
    var sec = utctimecalc.getSeconds();
    var time = date + '.' + month + '.' + year + ' ' + hour + ':' + min + ' Uhr';

    // recalculating
    var weathercondtioniconhtml = "http://openweathermap.org/img/w/" + weatherconditionicon + ".png";
    var weathertimenormal = time; // reallocate time var....
    var temperaturecelsius = Math.round((temperature - 273) * 100) / 100;  // Converting Kelvin to Celsius
    var windspeedknots = Math.round((windspeed * 1.94) * 100) / 100; // Windspeed from m/s in Knots; Round to 2 decimals
    var windspeedkmh = Math.round((windspeed * 3.6) * 100) / 100; // Windspeed from m/s in km/h; Round to 2 decimals
    var winddirectionstring = "Im the wind from direction"; // Wind from direction x as text
    if (winddirection > 348.75 &&  winddirection <= 11.25) {
        winddirectionstring =  "North";
    } else if (winddirection > 11.25 &&  winddirection <= 33.75) {
        winddirectionstring =  "Northnortheast";
    } else if (winddirection > 33.75 &&  winddirection <= 56.25) {
        winddirectionstring =  "Northeast";
    } else if (winddirection > 56.25 &&  winddirection <= 78.75) {
        winddirectionstring =  "Eastnortheast";
    } else if (winddirection > 78.75 &&  winddirection <= 101.25) {
        winddirectionstring =  "East";
    } else if (winddirection > 101.25 &&  winddirection <= 123.75) {
        winddirectionstring =  "Eastsoutheast";
    } else if (winddirection > 123.75 &&  winddirection <= 146.25) {
        winddirectionstring =  "Southeast";
    } else if (winddirection > 146.25 &&  winddirection <= 168.75) {
        winddirectionstring =  "Southsoutheast";
    } else if (winddirection > 168.75 &&  winddirection <= 191.25) {
        winddirectionstring =  "South";
    } else if (winddirection > 191.25 &&  winddirection <= 213.75) {
        winddirectionstring =  "Southsouthwest";
    } else if (winddirection > 213.75 &&  winddirection <= 236.25) {
        winddirectionstring =  "Southwest";
    } else if (winddirection > 236.25 &&  winddirection <= 258.75) {
        winddirectionstring =  "Westsouthwest";
    } else if (winddirection > 258.75 &&  winddirection <= 281.25) {
        winddirectionstring =  "West";
    } else if (winddirection > 281.25 &&  winddirection <= 303.75) {
        winddirectionstring =  "Westnorthwest";
    } else if (winddirection > 303.75 &&  winddirection <= 326.25) {
        winddirectionstring =  "Northwest";
    } else if (winddirection > 326.25 &&  winddirection <= 348.75) {
        winddirectionstring =  "Northnorthwest";
    } else {
        winddirectionstring =  " - currently no winddata available - ";
    };

//Popup with content
    var fontsizesmall = 1;
    popup.setContent("Weather Data:<br>" + "<img src=" + weathercondtioniconhtml 
    + "><br>" + weatherconditionstring + " (Weather-ID: " 
    + weatherconditionid + "): " + weatherconditiondescription 
    + "<br><br>Temperature: " + temperaturecelsius 
    + "°C<br>Airpressure: " + airpressure + " hPa<br>Humidityt: " 
    + airhumidity + "%" + "<br>Cloudcoverage: " + cloudcoverage 
    + "%<br><br>Windspeed: " + windspeedkmh + " km/h<br>Wind from direction: " 
    + winddirectionstring + " (" + winddirection + "°)" + "<br><br><font size=" 
    + fontsizesmall + ">Datasource:<br>openweathermap.org<br>Measure time: " 
    + weathertimenormal + "<br>Weatherstation: " + weatherstationname 
    + "<br>Weatherstation-ID: " 
    + weatherstationid + "<br>Weatherstation Coordinates: " 
    + weatherlocation_lon + ", " + weatherlocation_lat);           


    },
    error: function() {
      alert("error receiving wind data from openweathermap");
    }
  });        
});
//getting json function ends here

//popupfunction ends here
}

//popup
map.on('contextmenu', onMapClick);


</script>





</html>





